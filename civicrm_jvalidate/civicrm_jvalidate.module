<?php

function civicrm_jvalidate_page_attachments(array &$page) {
  $lang = \Drupal::languageManager()->getCurrentLanguage()->getId();
  $config = array('jvalidate' => array(
    'ext'=> t('Phone Ext.'),
    'extprompt' => t('Enter phone number Ext.'),
    'notw' => t('other format?'),
    'notwprompt' => t('Enter id below.'),
    'imeNotify' => t('Please close your Input Method to input number'),
    'lang' => $lang,
    'phoneMask' => '',
    'mobileMask' => '',
    'phoneValidator' => '',
  ));
  $phone_mask = \Drupal::config('civicrm_jvalidate.settings')->get('phone_mask');
  $mobile_mask = \Drupal::config('civicrm_jvalidate.settings')->get('mobile_mask');
  $phone_validator = \Drupal::config('civicrm_jvalidate.settings')->get('phone_validator');
  if ($phone_mask) {
    $config['jvalidate']['phoneMask'] = $phone_mask;
  }
  if ($mobile_mask) {
    $config['jvalidate']['mobileMask'] = $mobile_mask;
  }
  if ($phone_validator) {
    $config['jvalidate']['phoneValidator'] = $phone_validator;
  }
  $page['#attached']['drupalSettings'] += $config;
}

function civicrm_jvalidate_library_info_alter(&$libraries, $extension) {
  if ($extension == 'civicrm') {
    $lang = \Drupal::languageManager()->getCurrentLanguage()->getId();
    $min = \Drupal::config('system.performance')->get('js.preprocess') ? '.min' : '';
    $jvalidate = array('weight' => -5, 'header' => TRUE);
    $libraries['civicrm-js-packages']['js']['../neticrm/civicrm_jvalidate/js/jquery.validate'.$min.'.js'] = $jvalidate;
    if ($lang == 'zh-hant') {
      $libraries['civicrm-js-packages']['js']['../neticrm/civicrm_jvalidate/js/localization/messages_tw.js'] = $jvalidate;
    }
    $libraries['civicrm-js-packages']['js']['../neticrm/civicrm_jvalidate/js/custom-methods.js'] = $jvalidate;
    $libraries['civicrm-js-packages']['js']['../neticrm/civicrm_jvalidate/js/jquery.maskedinput.js'] = $jvalidate;
    $libraries['civicrm-js-packages']['js']['../neticrm/civicrm_jvalidate/civicrm_jvalidate.js'] = $jvalidate;
  }
}
